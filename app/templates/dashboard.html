<!DOCTYPE html>
<html>
<head>
    <title>Weather App</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body class="bg-light">
<div class="container mt-5 text-center">


    <h1 class="mb-4">üå§ Weather App</h1>
     <p class="lead">Created by: <strong>Nishu Chowdhury</strong></p>

    <h4 class="mb-4">Hello {{ request.cookies.get('name') }}</h4>
    <section class="info-section text-center">
            <h2>About PM Accelerator</h2>
            <p>
                PM Accelerator is a professional community dedicated to helping Product Managers grow their skills,
                network, and careers. Learn more about our mission and updates on our
                <a href="https://www.linkedin.com/school/pmaccelerator/" target="_blank">LinkedIn Page</a>.
            </p>
        </section>


    <!-- Weather Form -->
    <form id="weatherForm">
        <div class="row justify-content-center">
            <div class="col-md-3">
                <input type="date" id="fromdate" name="fromdate" class="form-control mb-3" required>
            </div>
            <div class="col-md-3">
                <input type="date" id="todate" name="todate" class="form-control mb-3" required>
            </div>
        </div>

        <div class="row justify-content-center">
            <div class="col-md-6">
                <input type="text" id="location" name="location" placeholder="Enter city or landmark" class="form-control mb-3" required>
            </div>
        </div>

        <button type="submit" class="btn btn-primary">Get Weather</button>
        <button type="button" id="geoBtn" class="btn btn-success">Use My Location</button>
    </form>

    <a href="/history" class="d-block mt-3">History</a>

    <div id="weatherResult" class="mt-5"></div>
    <div id="extraInfo" class="mt-5 text-start"></div>
</div>

<script>
$(document).ready(function() {
    // Default date range: today ‚Üí +5 days
    let today = new Date().toISOString().split('T')[0];
    let next5 = new Date();
    next5.setDate(new Date().getDate() + 5);
    $("#fromdate").val(today);
    $("#todate").val(next5.toISOString().split('T')[0]);
});

// Submit form ‚Üí call backend
$("#weatherForm").submit(function(e) {
    e.preventDefault();
    const fromdate = new Date($("#fromdate").val());
    const todate = new Date($("#todate").val());
    if (todate < fromdate) {
        alert("‚ùå 'To Date' cannot be earlier than 'From Date'!");
        return;
    }

    $.post("/weather", {
        location: $("#location").val(),
        fromdate: $("#fromdate").val(),
        todate: $("#todate").val()
    }, function(data) {
        displayWeather(data);
    }).fail(() => alert("‚ùå Location not found!"));
});

// Use My Location Button
$("#geoBtn").click(async function() {
    const fromdate = new Date($("#fromdate").val());
    const todate = new Date($("#todate").val());
    if (todate < fromdate) {
        alert("‚ùå 'To Date' cannot be earlier than 'From Date'!");
        return;
    }

    if (!navigator.geolocation) {
        alert("Geolocation not supported!");
        return;
    }

    navigator.geolocation.getCurrentPosition(async function(pos) {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        try {
            const res = await fetch(`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&count=1`);
            const data = await res.json();
            let locationName = "Unknown Location";
            if (data.results && data.results.length > 0) {
                const city = data.results[0].name;
                const country = data.results[0].country;
                locationName = country ? `${city}, ${country}` : city;
            }
            $("#location").val(locationName);
        } catch (err) {
            console.error(err);
            $("#location").val("Error fetching location");
        }

        $.post("/weather", {
            lat: lat,
            lon: lon,
            fromdate: $("#fromdate").val(),
            todate: $("#todate").val()
        }, function(data) {
            $("#location").val(`${data.current.city}, ${data.current.country}`);
            displayWeather(data);
        }).fail(() => alert("‚ùå Weather data not found!"));
    }, function(err) {
        alert("‚ùå Unable to get your location");
        console.error(err);
    });
});

function getWeatherIcon(description) {
    description = (description || "").toLowerCase();
    if (description.includes("clear")) return "fa-solid fa-sun text-warning";
    if (description.includes("cloud")) return "fa-solid fa-cloud text-secondary";
    if (description.includes("rain")) return "fa-solid fa-cloud-rain text-primary";
    if (description.includes("drizzle")) return "fa-solid fa-cloud-sun-rain text-info";
    if (description.includes("snow")) return "fa-solid fa-snowflake text-info";
    if (description.includes("thunder")) return "fa-solid fa-bolt text-warning";
    if (description.includes("fog") || description.includes("mist") || description.includes("haze"))
        return "fa-solid fa-smog text-muted";
    return "fa-solid fa-cloud text-secondary";
}

// Display Weather
function displayWeather(data) {
    if (!data || !data.current) {
        $("#weatherResult").html('<div class="alert alert-warning">No weather data returned.</div>');
        return;
    }

    let iconClass = getWeatherIcon(data.current.description);
    let html = `
        <div class="card shadow-lg mx-auto p-4 mb-4" style="max-width: 500px;">
            <h2>${data.current.city || ""}${data.current.country ? ", " + data.current.country : ""}</h2>
            <i class="${iconClass}" style="font-size: 60px;"></i>
            <h3 class="mt-3"><strong>${data.current.temp}¬∞C</strong></h3>
            <p class="text-capitalize">${data.current.description}</p>
            <p>üå¨ Wind: ${data.current.windspeed} km/h</p>
        </div>

        <h3 class="mt-4 text-primary">Days Forecast</h3>
        <div class="row justify-content-center">
    `;

    (data.forecast || []).forEach(f => {
        let forecastIcon = getWeatherIcon(f.description);
        html += `
            <div class="col-md-2 col-sm-4 card m-2 p-3 shadow-sm border-0" style="border-radius: 12px;">
                <p><strong>${f.date}</strong></p>
                <i class="${forecastIcon}" style="font-size: 36px;"></i>
                <p class="mt-2">${f.temp_min}¬∞C ‚Äì ${f.temp_max}¬∞C</p>
                <small class="text-muted text-capitalize">${f.description}</small>
            </div>`;
    });

    html += `</div>`;
    $("#weatherResult").html(html);

    // Only show Wikipedia information now (no map / iframes)
    const locationName = $("#location").val() || (data.current.city || "");
    displayWikipediaOnly(locationName);
}

// Wikipedia-only extra info
function displayWikipediaOnly(location) {
    const safeQuery = encodeURIComponent(location || ""); // fallback if empty
    let wikiContainer = `
        <h3 class="mt-4 text-primary">üìñ About ${location || "the location"}</h3>
        <div id="wikiBox" class="card p-3 mb-4">
            <p id="wikiSummary">Loading Wikipedia summary...</p>
            <p id="wikiReadMore" class="mt-2"></p>
        </div>
    `;
    $("#extraInfo").html(wikiContainer);

    if (!location) {
        $("#wikiSummary").text("No location provided to search on Wikipedia.");
        return;
    }

    fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${safeQuery}`)
        .then(res => {
            if (!res.ok) throw new Error("No wiki page");
            return res.json();
        })
        .then(data => {
            if (data.extract) {
                $("#wikiSummary").text(data.extract);
                if (data.content_urls && data.content_urls.desktop && data.content_urls.desktop.page) {
                    $("#wikiReadMore").html(`<a href="${data.content_urls.desktop.page}" target="_blank">Read more on Wikipedia</a>`);
                } else if (data.wikipedia) {
                    $("#wikiReadMore").html(`<a href="https://en.wikipedia.org/wiki/${safeQuery}" target="_blank">Read more on Wikipedia</a>`);
                }
            } else {
                $("#wikiSummary").text("No Wikipedia summary found for this location.");
            }
        })
        .catch(err => {
            console.warn("Wikipedia fetch error:", err);
            $("#wikiSummary").text("No Wikipedia information available for this location.");
            $("#wikiReadMore").text("");
        });
}
</script>
</body>
</html>
