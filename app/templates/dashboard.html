<!DOCTYPE html>
<html>
<head>
    <title>Weather App</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body class="bg-light">
<div class="container mt-5 text-center">
    <h1 class="mb-4">üå§ Weather App</h1>
        <h4 class="mb-4">Hello {{ request.cookies.get('name') }}</h4>

    <form id="weatherForm">
        <div class="row justify-content-center">
            <div class="col-md-3">
                <input type="date" id="fromdate" name="fromdate" class="form-control mb-3" required>
            </div>
            <div class="col-md-3">
                <input type="date" id="todate" name="todate" class="form-control mb-3" required>
            </div>
        </div>

        <div class="row justify-content-center">
            <div class="col-md-6">
                <input type="text" id="location" name="location" placeholder="Enter city or landmark" class="form-control mb-3" required>
            </div>
        </div>

        <button type="submit" class="btn btn-primary">Get Weather</button>
        <button type="button" id="geoBtn" class="btn btn-success">Use My Location</button>
    </form>
<a href="/history">History</a>
    <div id="weatherResult" class="mt-5"></div>
</div>

<script>
    const REVERSE_GEOCODE_URL = "https://geocoding-api.open-meteo.com/v1/reverse";
$(document).ready(function() {
    // üóì Default date range = today to +5 days
    let today = new Date().toISOString().split('T')[0];
    let next5 = new Date();
    next5.setDate(new Date().getDate() + 5);
    let futureDate = next5.toISOString().split('T')[0];
    $("#fromdate").val(today);
    $("#todate").val(futureDate);
});

$("#weatherForm").submit(function(e) {
    e.preventDefault();
    const fromdate = new Date($("#fromdate").val());
    const todate = new Date($("#todate").val());


    if (todate < fromdate) {
        alert("‚ùå 'To Date' cannot be earlier than 'From Date'!");
        return;
    }
    $.post("/weather", {
        location: $("#location").val(),
        fromdate: $("#fromdate").val(),
        todate: $("#todate").val()
    }, function(data) {
        displayWeather(data);
    }).fail(() => alert("‚ùå Location not found!"));
});

$("#geoBtn").click(async function() {
    const fromdate = new Date($("#fromdate").val());
    const todate = new Date($("#todate").val());

    if (todate < fromdate) {
        alert("‚ùå 'To Date' cannot be earlier than 'From Date'!");
        return;
    }

    if (!navigator.geolocation) {
        alert("Geolocation not supported!");
        return;
    }

    navigator.geolocation.getCurrentPosition(async function(pos) {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;


        // ‚úÖ Reverse geocode first
        try {
            const REVERSE_GEOCODE_URL = "https://geocoding-api.open-meteo.com/v1/reverse";
            const res = await fetch(`${REVERSE_GEOCODE_URL}?latitude=${lat}&longitude=${lon}&count=1`);
            const data = await res.json();

            let locationName = "Unknown Location";
            if (data.results && data.results.length > 0) {
                const city = data.results[0].name;
                const country = data.results[0].country;
                locationName = country ? `${city}, ${country}` : city;
            }
alert(locationName);
            // ‚úÖ Set location input box
            $("#location").val(locationName);

        } catch (err) {
            console.error(err);
            $("#location").val("Error fetching location");
        }

        // ‚úÖ Fetch weather after setting location
        $.post("/weather", {
            lat: lat,
            lon: lon,
            fromdate: $("#fromdate").val(),
            todate: $("#todate").val()
        }, function(data) {
            // Update location again from backend if needed
            $("#location").val(`${data.current.city}, ${data.current.country}`);
            displayWeather(data);
        }).fail(() => alert("‚ùå Weather data not found!"));
    }, function(err) {
        alert("‚ùå Unable to get your location");
        console.error(err);
    });
});
// üå§ Map weather descriptions to icons
function getWeatherIcon(description) {
    description = description.toLowerCase();
    if (description.includes("clear")) return "fa-solid fa-sun text-warning";
    if (description.includes("cloud")) return "fa-solid fa-cloud text-secondary";
    if (description.includes("rain")) return "fa-solid fa-cloud-rain text-primary";
    if (description.includes("drizzle")) return "fa-solid fa-cloud-sun-rain text-info";
    if (description.includes("snow")) return "fa-solid fa-snowflake text-info";
    if (description.includes("thunder")) return "fa-solid fa-bolt text-warning";
    if (description.includes("fog") || description.includes("mist") || description.includes("haze"))
        return "fa-solid fa-smog text-muted";
    return "fa-solid fa-cloud text-secondary";
}

function displayWeather(data) {
    let iconClass = getWeatherIcon(data.current.description);

    let html = `
        <div class="card shadow-lg mx-auto p-4 mb-4" style="max-width: 500px;">
            <h2>${data.current.city}, ${data.current.country}</h2>
            <i class="${iconClass}" style="font-size: 60px;"></i>
            <h3 class="mt-3"><strong>${data.current.temp}¬∞C</strong></h3>
            <p class="text-capitalize">${data.current.description}</p>
            <p>üå¨ Wind: ${data.current.windspeed} km/h</p>
        </div>

        <h3 class="mt-4 text-primary">Days Forecast</h3>
        <div class="row justify-content-center">
    `;

    data.forecast.forEach(f => {
        let forecastIcon = getWeatherIcon(f.description);
        html += `
            <div class="col-md-2 col-sm-4 card m-2 p-3 shadow-sm border-0" style="border-radius: 12px;">
                <p><strong>${f.date}</strong></p>
                <i class="${forecastIcon}" style="font-size: 36px;"></i>
                <p class="mt-2">${f.temp_min}¬∞C ‚Äì ${f.temp_max}¬∞C</p>
                <small class="text-muted text-capitalize">${f.description}</small>
            </div>`;
    });

    html += `</div>`;
    $("#weatherResult").html(html);
}
</script>
</body>
</html>
